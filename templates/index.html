<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Globus Bank Support</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:           #0b0f1a;
      --surface:      #131929;
      --surface2:     #1a2236;
      --border:       #243050;
      --accent:       #1e6fff;
      --accent-dark:  #1456cc;
      --text:         #dce4f5;
      --text-muted:   #6a7fa8;
      --user-bubble:  #0e3580;
      --bot-bubble:   #161f33;
      --success:      #2ecc8a;
      --warn:         #f0a500;
      --radius:       14px;
      --font:         'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* â”€â”€ Auth Screen â”€â”€ */
    #auth-screen {
      width: 100%;
      max-width: 440px;
      padding: 2.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 12px 48px rgba(0,0,0,0.5);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .brand-icon {
      width: 44px; height: 44px;
      background: var(--accent);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem;
    }
    .brand-name { font-size: 1.2rem; font-weight: 700; }
    .brand-sub  { font-size: 0.75rem; color: var(--text-muted); }

    #auth-screen p { color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.5rem; line-height: 1.5; }

    label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.4rem; }

    input[type="text"] {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.8rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus { border-color: var(--accent); }

    .btn {
      width: 100%;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.8rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.85rem;
      transition: background 0.2s;
    }
    .btn:hover    { background: var(--accent-dark); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .auth-msg {
      display: none;
      margin-top: 1rem;
      padding: 0.65rem 1rem;
      border-radius: 7px;
      font-size: 0.84rem;
      line-height: 1.4;
    }
    .auth-msg.error   { background: rgba(220,60,60,0.12); color: #f87171; border: 1px solid rgba(220,60,60,0.25); }
    .auth-msg.success { background: rgba(46,204,138,0.1);  color: var(--success); border: 1px solid rgba(46,204,138,0.25); }

    /* â”€â”€ Chat Screen â”€â”€ */
    #chat-screen {
      display: none;
      flex-direction: column;
      width: 100%;
      max-width: 760px;
      height: 90vh;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 12px 48px rgba(0,0,0,0.5);
    }

    .chat-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface2);
    }
    .header-left { display: flex; align-items: center; gap: 0.75rem; }
    .header-icon {
      width: 36px; height: 36px;
      background: var(--accent);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
    }
    .header-title    { font-weight: 700; font-size: 0.95rem; }
    .header-subtitle { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }

    .header-right { display: flex; gap: 0.65rem; align-items: center; }

    .badge {
      font-size: 0.7rem; font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
    }
    .badge.auth { background: rgba(46,204,138,0.12); color: var(--success); }
    .badge.anon { background: rgba(240,165,0,0.12);  color: var(--warn); }

    .sign-out-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .sign-out-btn:hover { border-color: var(--accent); color: var(--accent); }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }

    .message { display: flex; flex-direction: column; max-width: 82%; }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.bot  { align-self: flex-start; align-items: flex-start; }

    .bubble {
      padding: 0.75rem 1rem;
      border-radius: 14px;
      font-size: 0.9rem;
      line-height: 1.55;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .message.user .bubble {
      background: var(--user-bubble);
      border-bottom-right-radius: 4px;
    }
    .message.bot .bubble {
      background: var(--bot-bubble);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .meta { font-size: 0.68rem; color: var(--text-muted); margin-top: 4px; padding: 0 4px; }

    /* Typing indicator */
    .typing .bubble { display: flex; gap: 5px; align-items: center; padding: 1rem 1.1rem; }
    .dot {
      width: 7px; height: 7px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: pulse 1.2s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
      30%            { transform: translateY(-6px); opacity: 1; }
    }

    .input-area {
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.75rem;
      background: var(--surface2);
    }
    .input-area input { flex: 1; margin: 0; }
    .send-btn {
      width: auto;
      margin: 0;
      padding: 0.8rem 1.4rem;
      white-space: nowrap;
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
  </style>
</head>
<body>

<!-- â”€â”€ Auth Screen â”€â”€ -->
<div id="auth-screen">
  <div class="brand">
    <div class="brand-icon">ğŸ¦</div>
    <div>
      <div class="brand-name">Globus Bank</div>
      <div class="brand-sub">Virtual Support Assistant</div>
    </div>
  </div>
  <p>Enter your Globus Bank account number to access personalised support. No account number? You can still ask about our products and services.</p>
  <label for="acct-input">Account Number</label>
  <input type="text" id="acct-input" placeholder="e.g. 100023489" autocomplete="off"/>
  <button class="btn" id="auth-btn" onclick="authenticate()">Continue</button>
  <div class="auth-msg" id="auth-msg"></div>
</div>

<!-- â”€â”€ Chat Screen â”€â”€ -->
<div id="chat-screen">
  <div class="chat-header">
    <div class="header-left">
      <div class="header-icon">ğŸ¦</div>
      <div>
        <div class="header-title">Globus Bank Support</div>
        <div class="header-subtitle" id="header-sub">Virtual Assistant</div>
      </div>
    </div>
    <div class="header-right">
      <span class="badge anon" id="session-badge">Guest</span>
      <button class="sign-out-btn" onclick="resetSession()">Sign out</button>
    </div>
  </div>

  <div id="messages"></div>

  <div class="input-area">
    <input type="text" id="chat-input" placeholder="Type your messageâ€¦"
           autocomplete="off" onkeydown="if(event.key==='Enter') sendMessage()"/>
    <button class="btn send-btn" id="send-btn" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
  // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showAuthMsg(text, type) {
    const el = document.getElementById('auth-msg');
    el.textContent = text;
    el.className = `auth-msg ${type}`;
    el.style.display = 'block';
  }

  async function authenticate() {
    const input  = document.getElementById('acct-input');
    const btn    = document.getElementById('auth-btn');
    const acctNo = input.value.trim();
    if (!acctNo) { showAuthMsg('Please enter an account number.', 'error'); return; }

    btn.disabled = true;
    btn.textContent = 'Checkingâ€¦';

    try {
      const res  = await fetch('/api/authenticate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ account_number: acctNo }),
      });
      const data = await res.json();

      if (data.success) {
        showAuthMsg(data.message, 'success');
        setTimeout(() => launchChat(data.name, data.message, true), 500);
      } else {
        showAuthMsg(data.message, 'error');
        btn.textContent = 'Continue as Guest';
        btn.disabled = false;
        // Allow guest access after 1.5s
        setTimeout(() => launchChat(null, data.message, false), 1500);
      }
    } catch {
      showAuthMsg('Could not connect to the server. Is it running?', 'error');
      btn.disabled = false;
      btn.textContent = 'Continue';
    }
  }

  // â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function launchChat(name, welcomeMsg, isAuth) {
    document.getElementById('auth-screen').style.display = 'none';
    const chat = document.getElementById('chat-screen');
    chat.style.display = 'flex';

    const badge = document.getElementById('session-badge');
    const sub   = document.getElementById('header-sub');

    if (isAuth && name) {
      badge.textContent = name;
      badge.className   = 'badge auth';
      sub.textContent   = 'Authenticated session';
    } else {
      badge.textContent = 'Guest';
      badge.className   = 'badge anon';
      sub.textContent   = 'General enquiries only';
    }

    addBotMessage(welcomeMsg);
    document.getElementById('chat-input').focus();
  }

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const btn   = document.getElementById('send-btn');
    const text  = input.value.trim();
    if (!text) return;

    input.value   = '';
    input.disabled = true;
    btn.disabled  = true;

    addUserMessage(text);
    const typingId = addTyping();

    try {
      const res  = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text }),
      });
      const data = await res.json();
      removeTyping(typingId);

      if (data.error) {
        addBotMessage(data.error);
      } else {
        addBotMessage(data.reply, data.intent);
      }
    } catch {
      removeTyping(typingId);
      addBotMessage('Something went wrong. Please try again.');
    }

    input.disabled = false;
    btn.disabled   = false;
    input.focus();
  }

  // â”€â”€ Message helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addUserMessage(text) {
    const msgs   = document.getElementById('messages');
    const div    = document.createElement('div');
    div.className = 'message user';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    div.appendChild(bubble);
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function addBotMessage(text, intent) {
    const msgs   = document.getElementById('messages');
    const div    = document.createElement('div');
    div.className = 'message bot';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    div.appendChild(bubble);

    if (intent) {
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `intent: ${intent}`;
      div.appendChild(meta);
    }

    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function addTyping() {
    const msgs = document.getElementById('messages');
    const div  = document.createElement('div');
    const id   = 'typing-' + Date.now();
    div.id = id;
    div.className = 'message bot typing';
    div.innerHTML = '<div class="bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return id;
  }

  function removeTyping(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }

  async function resetSession() {
    await fetch('/api/reset', { method: 'POST' });
    document.getElementById('chat-screen').style.display = 'none';
    document.getElementById('auth-screen').style.display = 'block';
    document.getElementById('acct-input').value = '';
    document.getElementById('auth-msg').style.display = 'none';
    document.getElementById('auth-btn').disabled = false;
    document.getElementById('auth-btn').textContent = 'Continue';
    document.getElementById('messages').innerHTML = '';
  }

  // Enter key on auth screen
  document.getElementById('acct-input')
    .addEventListener('keydown', e => { if (e.key === 'Enter') authenticate(); });
</script>
</body>
</html>
